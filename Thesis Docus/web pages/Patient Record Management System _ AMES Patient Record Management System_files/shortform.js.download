jQuery(document).ready(function () {

  jQuery("#vai").click(function () {

    jQuery('#loading').show();
    jQuery('#loading').html("Please wait.."+"<img src='http://llg.sequentia.net/images/ajax.gif'/>");
    if (document.form1.email.value=="") {
      jQuery('#loading').html("");
      alert('Please provide your email address.');
      return (false);
    }
    if (document.form1.email.value.indexOf("'")> -1) {
      jQuery('#loading').html("");
      alert('Invalid email');
      return (false);
    }
    if (document.form1.email.value.indexOf('"')> -1) {
      jQuery('#loading').html("");
      alert('Invalid email');
      return (false);
    }

    var uri = llaJsHost + _llat.scriptHost + "/lla.aspx"+
              "?i="+Base64.encode(_llat.domain)+
              "&ll_m="+Base64.encode("GetLeadProperties")+
              "&ll_cb="+Base64.encode("emailCallback")+
              "&ll_dn="+Base64.encode(_llat.domain)+
              "&ll_e="+Base64.encode(document.form1.email.value);

    jQuery.ajax({
      type: "GET",
      cache: false,
      async: false,
      url: uri,
      dataType: "script",
      error: function (xhr,error,exception) {
        //alert("ajax fail: " + xhr.status);
        jQuery('#loading').html("");
        //console.log("Contact information not found.");
        document.getElementById("radio2").click();
      },
      success: function (data,textStatus) {
        //console.log("ajax success: "+textStatus);
        jQuery('#loading').html("");
      },
      complete: function (xhr,textStatus) {
        //console.log("ajax complete: "+textStatus);
      }
    });
    //console.log("after ajax");
    return (false);
  });
});

function emailCallback(result) {

  jQuery('#loading').html("");

  try {
    var leadPropertiesJson = Base64.decode(result);
    var leadProperties = JSON2.parse(leadPropertiesJson);

    var email = GetValueOf(leadProperties, "Email");
    var source = GetValueOf(leadProperties, "Source");
    var first_name = GetValueOf(leadProperties, "FirstName");
    var last_name = GetValueOf(leadProperties, "LastName");
    var phone_main = GetValueOf(leadProperties, "LeadPhones.Phone{Toll}.Number");
    var bus_name = GetValueOf(leadProperties, "Company.Name");
    var zip = GetValueOf(leadProperties, "LeadLocations.Location{Office}.Zip");
    var industry = GetValueOf(leadProperties, "Company.Industry");
    var number_of_employees = GetValueOf(leadProperties, "Company.EmployeeCount");

    if ((email!=null)&&(email.length>0)&&
       (source!=null)&&(source.length>0)&&
       (first_name!=null)&&(first_name.length>0)&&
       (last_name!=null)&&(last_name.length>0)&&
       (phone_main!=null)&&(phone_main.length>0)&&
       (bus_name!=null)&&(bus_name.length>0)&&
       (zip!=null)&&(zip.length>0)) {

      if (document.getElementById('ppccode')!=null) {
        urchinTracker(document.getElementById('ppccode').value);
      }

      var noIndustry=((industry==null)||(industry.length<1)||(number_of_employees==null)||(number_of_employees.length<1));

	    var thankYouPage = "http://llg.sequentia.net/thankspages/thanks.html";
	    if (document.testOnlineFormName.ReturnPage!=null && document.testOnlineFormName.ReturnPage.value!="")
	      thankYouPage = document.testOnlineFormName.ReturnPage;
	    else if (document.testOnlineFormName.action != null && document.testOnlineFormName.action != "") {
	      thankYouPage = document.testOnlineFormName.action;
		    thankYouPage = thankYouPage.replace("http://leadlifesolutions.net/Tab/Submit?ll_rurl=", "");
	    }

      if (noIndustry) {
        // Form is partially completed
        jQuery("#form1").append("<input type=\"hidden\" id=\"ll_form_complete\" name=\"ll_partialform\" value=\"true\">");
        thankYouPage = "http://tabfusionrm-8c943c92.s3.amazonaws.com/Form%20Pages/" + _llat.domain + "_secondary_form-industry_organization_size.htm?email=" + email + "&dest=" + encodeURI(thankYouPage);
      }

      var newAction = llaJsHost + "leadlifesolutions.net/Tab/Submit?ll_ignoreRepost=true&ll_rurl=";

      newAction += encodeURIComponent(thankYouPage);

      jQuery("#form1").attr("action", newAction);

      // call form submit and client-side validation succeeded
      jQuery('#form1').submit();

      // Validation failed so do not submit the form
      return (false);
    }
  }
  catch(e) {
    console.log("emailCallback "+e);
  }

  alert("Contact information not found."); // do not remove - this is part of normal user interaction

  document.getElementById("radio2").click();
  return (false);
}

function showDiv(flag) {
  if(flag==1) {
    document.getElementById('bigForm').style.display="none";
    document.getElementById('smallForm').style.display="";
  }
  else {
    document.getElementById('smallForm').style.display="none";
    document.getElementById('bigForm').style.display="";
  }
}

function change_W_I() {
  try {
    var objcountry=document.testOnlineFormName.PIID_23775_0;
    var country=objcountry.options[objcountry.selectedIndex].text;
    if(country=="Canada") {
      document.testOnlineFormName.W.value="43";
      document.testOnlineFormName.I.value="1";
    }
    else {
      document.testOnlineFormName.W.value="42";
      document.testOnlineFormName.I.value="1";
    }
  }
  catch(e) {
  }
}


var GetValueOf = function (o, prop) {

    /* Attempt to located property by G2 property name */
    var l = o.length + 1;
    while (l -= 1) {
        if (o[l - 1].SystemProperty == prop) {
            return o[l - 1].Value;
        }
    }

    /* G2 property not found, located by mapped property name for compatibility */
    try {
      l = this.length + 1;
      while (l -= 1) {
          if (this[l - 1].MappedField === o) {
              return this[l - 1].Value;
          }
      }
    }
    catch (ex) {}

    /* G2 property not found, located by G1 property name for compatibility */
    l = o.length + 1;
    while (l -= 1) {
        if (o[l - 1].GenOneProperty == prop) {
            return o[l - 1].Value;
        }
    }

    return null;
};